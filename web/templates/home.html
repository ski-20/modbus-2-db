{% extends "base.html" %}
{% block content %}

<form id="f" class="row g-2 mb-3">
  <div class="col-sm-4">
    <label class="form-label">Tag</label>
    <select class="form-select" name="tag" id="tag">
      <option value="">(all)</option>
      {% for r in tags %}
        <option value="{{ r.tag }}" {% if r.tag == cur_tag %}selected{% endif %}>
          {{ r.label }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Date Range</label>
    <select class="form-select" name="cal" id="cal">
      <option value="all" {% if cur_cal == 'all' %}selected{% endif %}>(all)</option>
      <option value="today" {% if cur_cal == 'today' %}selected{% endif %}>Today</option>
      <option value="yesterday" {% if cur_cal == 'yesterday' %}selected{% endif %}>Yesterday</option>
      <option value="week" {% if cur_cal == 'week' %}selected{% endif %}>This Week</option>
      <option value="month" {% if cur_cal == 'month' %}selected{% endif %}>This Month</option>
      <option value="year" {% if cur_cal == 'year' %}selected{% endif %}>This Year</option>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Limit</label>
    <input class="form-control" name="limit" id="limit" value="500">
  </div>
  <div class="col-sm-2">
    <label class="form-label">Bucket (sec, optional)</label>
    <input class="form-control" name="bucket_s" id="bucket_s">
  </div>
  <div class="col-sm-2 align-self-end">
    <button id="loadBtn" class="btn btn-primary w-100" type="button">Load</button>
  </div>
</form>

<div class="mb-2">
  <a id="dl" class="btn btn-outline-secondary btn-sm" href="#">Download CSV</a>
</div>


<div class="table-responsive">
  <table class="table table-sm table-striped" id="tbl">
    <thead>
      <tr>
        <th>Timestamp (Local)</th>
        <th>Tag</th>
        <th>Value</th>
        <th>Unit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script>
function qs(id){ return document.getElementById(id); }

function buildParams(){
  const p = new URLSearchParams();
  const tag    = qs('tag').value.trim();
  const cal    = qs('cal').value || 'all';
  const limit  = qs('limit').value || '500';
  const bucket = qs('bucket_s').value || '';
  if (tag) p.set('tag', tag);
  p.set('cal', cal);
  p.set('limit', limit);
  if (bucket) p.set('bucket_s', bucket);
  return p;
}

function toOneDecimal(val) {
  // Handle numbers and numeric strings safely
  if (val === null || val === undefined) return '';
  const n = (typeof val === 'number') ? val : Number(val);
  if (Number.isFinite(n)) return n.toFixed(1);
  return String(val);
}

async function loadTable() {
  const p = buildParams();
  // Set CSV link
  qs('dl').href = '/api/download.csv?' + p.toString();

  let resp;
  try {
    resp = await fetch('/api/logs?' + p.toString(), { cache: 'no-store' });
  } catch (e) {
    console.error('Fetch error:', e);
    alert('Network error calling /api/logs. See console.');
    return;
  }

  if (!resp.ok) {
    const txt = await resp.text();
    console.error('API error:', resp.status, txt);
    alert('API error ' + resp.status + ': ' + txt);
    return;
  }

  let payload;
  try {
    payload = await resp.json();
  } catch (e) {
    console.error('JSON parse error:', e);
    alert('Could not parse /api/logs JSON.');
    return;
  }

  // Robustly extract rows regardless of shape
  const rows = Array.isArray(payload) ? payload
              : (Array.isArray(payload.rows) ? payload.rows
              : (Array.isArray(payload.data) ? payload.data : []));

  // Render table
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = rows.map(row => {
    const ts    = row.ts_fmt || row.ts || '';
    const label = row.label  || row.tag || '';
    const val   = toOneDecimal(row.value);
    const unit  = row.unit || '';
    return `<tr>
      <td>${ts}</td>
      <td>${label}</td>
      <td>${val}</td>
      <td>${unit}</td>
    </tr>`;
  }).join('');
}

document.getElementById('loadBtn').addEventListener('click', function(e){
  e.preventDefault();
  loadTable();
});

// first paint
loadTable();
</script>
{% endblock %}
