{% extends "base.html" %}
{% block content %}
<form id="f" class="row g-2 mb-3">
  <div class="col-md-4">
    <label class="form-label">Tag</label>
    <select class="form-select" name="tag">
    <option value="">(all)</option>
    {% for r in tags %}
      <option value="{{ r.tag }}" {% if r.tag == cur_tag %}selected{% endif %}>
        {{ r.label }}
      </option>
    {% endfor %}
  </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Calendar Range</label>
    <select class="form-select" name="cal" id="cal">
      <option value="today" selected>Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="week">This Week</option>
      <option value="month">This Month</option>
      <option value="year">This Year</option>
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">Limit</label>
    <input class="form-control" name="limit" value="{{ cur_limit }}">
  </div>

  <div class="col-md-2">
    <label class="form-label">Bucket (sec, optional)</label>
    <input class="form-control" name="bucket_s" value="{{ cur_bucket }}">
  </div>

  <div class="col-md-1 align-self-end">
    <button class="btn btn-primary w-100" type="submit">Load</button>
  </div>
</form>

<div class="mb-2">
  <a id="dl" class="btn btn-outline-secondary btn-sm" href="#">Download CSV</a>
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped" id="tbl">
    <thead>
      <tr><th>Timestamp (Local)</th><th>Tag</th><th>Value</th><th>Unit</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const f = document.getElementById('f');
const tbody = document.querySelector('#tbl tbody');
const dl = document.getElementById('dl');

async function loadTable() {
  const p = new URLSearchParams(new FormData(f));
  // Clean legacy params if they still exist
  p.delete('mins'); p.delete('range'); p.delete('start'); p.delete('end');

  dl.href = '/api/download.csv?' + p.toString();
  const r = await fetch('/api/logs?' + p.toString());
  const rows = await r.json();
  tbody.innerHTML = rows.map(row => (
    `<tr>
      <td>${row.ts_fmt || row.ts}</td>
      <td>${row.tag}</td>
      <td>${row.value}</td>
      <td>${row.unit || ''}</td>
    </tr>`
  )).join('');
}

f.addEventListener('submit', (e) => {
  e.preventDefault();
  loadTable();
});

// auto-load first paint
loadTable();
</script>

{% endblock %}
